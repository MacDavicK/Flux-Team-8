name: PR Safeguard

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-target-branch:
    name: Branch target check
    runs-on: ubuntu-latest

    steps:
      - name: Warn if PR targets main from a feature branch
        if: >
          github.event.pull_request.base.ref == 'main' &&
          !contains(fromJSON('["frontend", "backend", "data_access"]'), github.event.pull_request.head.ref)
        uses: actions/github-script@v7
        with:
          script: |
            const body = `⚠️ **Branch Target Warning**

            This PR targets \`main\` from \`${{ github.event.pull_request.head.ref }}\`.

            Our workflow is:
            1. Feature branches → PR into \`frontend\`, \`backend\`, or \`data_access\`
            2. Integration branches → PR into \`main\` (requires owner approval)

            **If this is intentional** (e.g., merging an integration branch into main), you can ignore this message. Kavish will review and merge.

            **If this was a mistake**, click **Edit** at the top-right of this PR and change the base branch to the correct integration branch.`;

            // Check if we already posted this warning to avoid duplicates
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botWarning = comments.data.find(
              (c) => c.user.type === "Bot" && c.body.includes("Branch Target Warning")
            );

            if (!botWarning) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Log branch info
        run: |
          echo "PR: ${{ github.event.pull_request.head.ref }} → ${{ github.event.pull_request.base.ref }}"
          echo "Status: OK"
