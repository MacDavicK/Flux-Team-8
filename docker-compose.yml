# ============================================================
# Flux — Docker Compose
# Orchestrates the DAO service, backend, and frontend.
# Requires local Supabase to be running (supabase start).
#
# Usage:
#   docker compose up --build   — build and start all services
#   docker compose up           — start without rebuilding
#   docker compose down         — stop all services
#   docker compose logs backend — tail backend logs
# ============================================================

services:
  # ---------- DAO Service ----------
  # Data persistence microservice. Uses SQLAlchemy → Supabase PostgreSQL.
  # Port 8001 is published to the host for standalone testing and build scripts.
  dao:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@host.docker.internal:54322/postgres
      - SERVICE_API_KEYS=["goal-planner-key-abc","scheduler-key-def","observer-key-ghi"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: uvicorn dao_service.main:app --host 0.0.0.0 --port 8001

  # ---------- FastAPI Backend ----------
  # Python API server with AI agent orchestration and conv_agent voice endpoints.
  # Waits for the DAO service to be healthy before starting.
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8000:8000"
    env_file:
      - ./backend/.env
    environment:
      # Override localhost URLs so they resolve from inside the container.
      - SUPABASE_URL=http://host.docker.internal:54321
      - DAO_SERVICE_URL=http://dao:8001
    depends_on:
      dao:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      # Mount source for live reload during development
      - ./backend:/app
    command: uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

  # ---------- React Frontend ----------
  # Vite/TanStack Start dev server. Auth runs server-side (SSR) inside this
  # container, so SUPABASE_URL must point to the host via host.docker.internal.
  # The browser calls the backend directly via localhost:8000, so VITE_API_URL
  # must stay as localhost:8000 (resolved by the user's browser, not the container).
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "3000:3000"
    env_file:
      - ./frontend/.env
    environment:
      # Override 127.0.0.1 so SSR auth calls reach the host's Supabase instance.
      - SUPABASE_URL=http://host.docker.internal:54321
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - backend
    volumes:
      # Mount source for live reload during development
      - ./frontend:/app
      # Prevent the host node_modules from overriding the container's
      - /app/node_modules
