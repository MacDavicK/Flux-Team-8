# Flux Backend

AI-powered accountability coach backend — FastAPI + LangGraph + LiteLLM.

---

## Prerequisites

- [Docker](https://docs.docker.com/get-docker/) and Docker Compose
- [uv](https://github.com/astral-sh/uv) (for local development without Docker)
- Python 3.12+
- A [Supabase](https://supabase.com) project
- An [OpenRouter](https://openrouter.ai) API key
- A [Twilio](https://twilio.com) account (WhatsApp + Voice + Verify)

---

## Quickstart

### 1. Clone the repo

```bash
git clone <repo-url>
cd flux-backend
```

### 2. Start the dev environment

Run `dev-start.sh` — it checks dependencies, configures `.env` interactively (skipping values already set), applies all database migrations via Docker, and starts the full stack:

```bash
bash dev-start.sh
```

This starts:
- **api** — FastAPI app on `http://localhost:8000`
- **notifier** — background notification worker
- **redis** — rate limiter and job store
- **ngrok** — tunnel for Twilio webhooks (local dev)

Swagger UI: `http://localhost:8000/docs`
ngrok inspector: `http://localhost:4040`

> **Production:** Do not set `NGROK_AUTHTOKEN` or `NGROK_DOMAIN`. Set `TWILIO_WEBHOOK_BASE_URL` to your deployed API URL instead.

### 3. Tear down the dev environment

```bash
bash dev-end.sh
```

This stops all containers, removes Compose volumes, prunes the Docker build cache, and cleans up `.venv` and Python cache files. Your `.env` is always preserved.

**Flags:**
- `--soft` — stop containers only; keep volumes and build cache

---

## Local Development (uv, no Docker for the app)

### 1. Install dependencies

```bash
uv sync
```

### 2. Configure environment and run migrations

```bash
bash dev-start.sh
```

`dev-start.sh` will guide you through each section with inline instructions on where to find each value.

### 3. Run the API server

```bash
uv run uvicorn app.main:app --reload --port 8000
```

### 4. Run the notifier worker (separate terminal)

```bash
uv run python -m notifier.main
```

---

## Environment Variable Reference

<details>
<summary>Expand</summary>

| Variable | Description |
|---|---|
| `SECRET_KEY` | Auto-generated by `dev-start.sh` |
| `DATABASE_URL` | Direct asyncpg connection — `postgresql+asyncpg://user:pass@host:5432/db` (port 5432, not 6543) |
| `SUPABASE_URL` | Your Supabase project URL |
| `SUPABASE_ANON_KEY` | Supabase anon key (used for JWT validation) |
| `SUPABASE_SERVICE_ROLE_KEY` | Service role key (used for all backend DB writes) |
| `OPENROUTER_API_KEY` | OpenRouter API key for LLM access |
| `TWILIO_ACCOUNT_SID` / `TWILIO_AUTH_TOKEN` | Twilio credentials |
| `TWILIO_WHATSAPP_FROM` | Twilio WhatsApp sender number (e.g. `whatsapp:+14155238886`) |
| `TWILIO_VOICE_FROM` | Twilio Voice caller number |
| `TWILIO_VERIFY_SERVICE_SID` | Twilio Verify service SID for OTP |
| `TWILIO_WEBHOOK_BASE_URL` | Public base URL Twilio will call back. Local dev: `https://<your-ngrok-domain>`. Production: your deployed API URL. |
| `VAPID_PRIVATE_KEY` | Auto-generated by `dev-start.sh` |
| `VAPID_PUBLIC_KEY` | Auto-generated by `dev-start.sh` — also pass this to your frontend's `PushManager.subscribe()` |
| `VAPID_CLAIMS_EMAIL` | Contact email for VAPID claims |
| `REDIS_URL` | Redis connection URL (default: `redis://redis:6379/0` with Docker Compose) |
| `LANGCHAIN_API_KEY` | LangSmith API key |
| `SENTRY_DSN` | Sentry DSN for error tracking |

</details>

---

## Project Structure

```
flux-backend/
├── app/
│   ├── agents/          # LangGraph agent nodes + graph assembly
│   │   ├── prompts/     # System prompt text files
│   │   ├── state.py     # AgentState TypedDict
│   │   ├── orchestrator.py
│   │   ├── goal_planner.py
│   │   ├── classifier.py
│   │   ├── scheduler.py
│   │   ├── pattern_observer.py
│   │   ├── onboarding.py
│   │   └── graph.py     # Compiled LangGraph graph
│   ├── api/v1/          # FastAPI route handlers
│   ├── middleware/      # Auth, logging, rate limiting
│   ├── models/          # Pydantic schemas (agent outputs, API, DB)
│   ├── services/        # DB, LLM, push, Twilio, RRULE, context manager
│   ├── config.py        # Settings via pydantic-settings
│   ├── dependencies.py  # FastAPI dependency injection
│   └── main.py          # FastAPI app entry point
├── migrations/          # SQL migration files (apply to Supabase)
├── notifier/            # Standalone notification worker (APScheduler)
├── tests/
│   ├── unit/
│   └── integration/
├── docker/
│   ├── Dockerfile.api
│   └── Dockerfile.notifier
├── docker-compose.yml
├── docker-compose.prod.yml
├── dev-start.sh         # Start: deps → .env → migrations → Docker stack
├── dev-end.sh           # Teardown: containers → volumes → caches
├── pyproject.toml
└── .env.example
```

---

## Running Tests

```bash
# Unit tests
uv run pytest tests/unit/ -v

# Integration tests (requires test DB configured in .env)
uv run pytest tests/integration/ -v

# All tests with coverage
uv run pytest --cov=app tests/ -v
```

---

## Architecture Overview

- **API Layer**: FastAPI with JWT auth (Supabase), per-user rate limiting (slowapi + Redis), structured logging (structlog)
- **Agent Layer**: LangGraph graph with Orchestrator → Goal Planner → Classifier + Scheduler + Pattern Observer (parallel fan-out) → Save Tasks
- **LLM**: All models accessed via OpenRouter (LiteLLM), with 3-tier fallbacks and monthly token budgets
- **Notifications**: Push (Web Push/VAPID) → WhatsApp (Twilio) → Voice call (Twilio DTMF) escalation chain, with atomic CAS to prevent duplicate dispatches
- **Database**: Supabase (PostgreSQL) with RLS enabled on all user-data tables; asyncpg for direct connections
